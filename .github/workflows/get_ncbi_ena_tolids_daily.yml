name: get_ncbi_ena_tolids_daily
env:
  RELEASE: 2022.04.11

# on:
#   schedule:
#     # Runs "at 5 min past midnight" (see https://crontab.guru)
#     - cron: '5 0 * * *'
on: workflow_dispatch

jobs:
  check-health:
    runs-on:  self-hosted
    steps:
      - name: Check es health
        run:  curl -s "http://es1:9200/_cat/health"
      - name: Get dockers
        run:  docker pull genomehubs/genomehubs:latest

  get-ncbi-datasets:
    needs:
      - check-health
    runs-on:  self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Download NCBI datasets executable
        run: |
          curl https://ftp.ncbi.nlm.nih.gov/pub/datasets/command-line/LATEST/linux-amd64/datasets > datasets
          chmod a+x datasets
      - name: Download NCBI eukaryota datasets zip
        run: |
          mkdir -p sources/assembly-data
          ./datasets download genome taxon "Eukaryota" --dehydrated --filename sources/assembly-data/eukaryota.zip
          unzip -o -d sources/assembly-data sources/assembly-data/eukaryota.zip ncbi_dataset/data/assembly_data_report.jsonl
      - name: Run docker genomehubs parse --ncbi-datasets
        run: |
          docker run --rm --network=host \
            -v `pwd`/sources:/genomehubs/sources \
            genomehubs/genomehubs:latest bash -c \
            "genomehubs parse --ncbi-datasets sources/assembly-data --outfile sources/assembly-data/ncbi_datasets_eukaryota.tsv.gz"
      - name: Clean up expanded zip
        run: |
            rm -rf sources/assembly-data/ncbi_dataset datasets
      - name: Commit changes if needed
        uses: stefanzweifel/git-auto-commit-action@v4

  get-refseq-organelles:
    needs:
      - get-ncbi-datasets
    runs-on:  self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Run docker genomehubs parse --refseq-organelles
        run: |
          docker run --rm --network=host \
            -v `pwd`/sources:/genomehubs/sources \
            genomehubs/genomehubs:latest bash -c \
            "genomehubs parse --refseq-organelles --outfile sources/assembly-data/refseq_organelles.tsv.gz"
      - name: Commit changes if needed
        uses: stefanzweifel/git-auto-commit-action@v4

  get-ena-taxonomy-extra:
    needs:
      - get-refseq-organelles
    runs-on:  self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Get extra ENA taxonomy nodes
        run:  |
          mkdir -p sources/ena-taxonomy
          cd sources/ena-taxonomy
          bash ../../scripts/get_ena_taxonomy_extra.bash
          rm -f ena-taxonomy.extra.jsonl ena-taxonomy.xml.taxids \
            resulttaxon.tax_tree2759.tsv ena-taxonomy.extra.prev.jsonl \
            ena-taxonomy.extra.prev.taxids resulttaxon.tax_tree2759.extra.curr.tsv \
            ena-taxonomy.extra.curr.jsonl
          cd ../../
      - name: Commit changes if needed
        uses: stefanzweifel/git-auto-commit-action@v4

  get-tolids:
    needs:
      - get-ena-taxonomy-extra
    runs-on:  self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Get extra ENA taxonomy nodes
        run:  |
          mkdir -p sources/tolids
          cd sources/tolids
          curl -s https://gitlab.com/wtsi-grit/darwin-tree-of-life-sample-naming/-/raw/master/tolids.txt \
          | gzip -c > sources/tolids/tolids.tsv.gz
          cd ../../
      - name: Commit changes if needed
        uses: stefanzweifel/git-auto-commit-action@v4
